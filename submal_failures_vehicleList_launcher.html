<!DOCTYPE html>
<html>
<head>
  <title>Analytics Redirector</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 10px;
    }
    button {
      padding: 10px 15px;
      font-size: 14px;
      cursor: pointer;
    }
  </style>
</head>
<body>
  <button onclick="redirectToAnalytics()">Open Analytics Query</button>

  <script>
    function redirectToAnalytics() {
      try {
        const referrer = document.referrer;
        console.log("Referrer URL:", referrer);
        if (!referrer) throw new Error("Missing referrer. Cannot determine controller URL.");

        const baseUrl = referrer.split('/controller')[0];

        // Extract timeRange param
        /*
          timeRange=last_5_minutes.BEFORE_NOW.-1.-1.5
          timeRange=last_1_hour.BEFORE_NOW.-1.-1.60
          timeRange=last_1_day.BEFORE_NOW.-1.-1.1440
          timeRange=last_1_week.BEFORE_NOW.-1.-1.10080
          timeRange=last_1_month.BEFORE_NOW.-1.-1.43200
          timeRange=last_1_year.BEFORE_NOW.-1.-1.525600
        */
        const timeRangeMatch = referrer.match(/timeRange=last_([0-9]+)_([a-zA-Z]+)/);
        let timeRangeClause = "since 1 days"; // fallback

        if (timeRangeMatch) {
          console.log("parsing timeRangeMatch", timeRangeMatch);
          const value = parseInt(timeRangeMatch[1]);
          const unit = timeRangeMatch[2].toLowerCase();

          // Normalize units: minute → minutes, hour → hours, etc.
          const unitMap = {
            minute: "minutes",
            minutes: "minutes",
            hour: "hours",
            hours: "hours",
            day: "days",
            days: "days",
            week: "weeks",
            weeks: "weeks",
            month: "months",
            months: "months",
            year: "years",
            years: "years"
          }

          const pluralUnit = unitMap[unit] || "days"; // default fallback
          timeRangeClause = `since ${value} ${pluralUnit}`;
        } else {
          console.log("No timeRange found in referrer. Using default 'since 1 days'.");  
        }


        const rawQuery = `SELECT vehicleId, count(*) AS "Failure Count" FROM rp_raw WHERE operation IN ("updateCommunicationsProfile", "switchCommunicationsProfile") AND success IS NULL ${timeRangeClause}`;
        const encodedQuery = encodeURIComponent(rawQuery);

        const analyticsPath = `/#/location=ANALYTICS_ADQL_SEARCH&searchType=SINGLE&searchMode=ADVANCED&viewMode=VISUALIZATION&visualization=TABLE&adqlQuery=${encodedQuery}`;
        const finalUrl = `${baseUrl}/controller${analyticsPath}`;

        window.open(finalUrl, '_blank');
      } catch (e) {
        alert('Failed to generate Analytics URL: ' + e.message);
      }
    }
  </script>
</body>
</html>